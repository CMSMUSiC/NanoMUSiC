#!/usr/bin/env python3

from enum import Enum
from typing import Union
import typer
import metadata
import sys
import os

############################################################################
############################################################################
# Classification
############################################################################
############################################################################
classification_app = typer.Typer()


@classification_app.command()
def build(config_file: str):
    import analysis_builder

    analysis_builder.build_analysis_config(config_file)


@classification_app.command()
def preprocess(config_file: str):
    import preprocessing

    preprocessing.preamble()
    preprocessing.compute_sum_weights(config_file)


class ClassificationTarget(str, Enum):
    Condor = "condor"
    Dev = "dev"
    Parallel = "parallel"


@classification_app.command()
def launch(
    config_file: str,
    target: ClassificationTarget = ClassificationTarget.Condor,
    process: Union[str, None] = None,
    year: Union[metadata.Years, None] = None,
    max_files: int = sys.maxsize,
    split_size: int = sys.maxsize,
    dry_run: bool = False,
    num_cpus: int = 100,
):
    import classification

    if not os.path.exists("sum_weights.json"):
        print("ERROR: Could not find sum_weights.json. Did you run the preprocess?")
        sys.exit(-1)

    if target == ClassificationTarget.Dev:
        classification.launch_dev(config_file, process, year, max_files)
    elif target == ClassificationTarget.Parallel:
        classification.launch_parallel(
            config_file, process, year, max_files, split_size, num_cpus
        )
    else:
        classification.launch_condor(
            config_file, process, year, max_files, split_size, dry_run
        )


@classification_app.command()
def merge(
    config_file: str,
    inputs_dir: str = "classification_outputs",
):
    import classification

    classification.merge_classification_outputs(config_file, inputs_dir)


@classification_app.command()
def unwrap(
    config_file: str,
    inputs_dir: str = "classification_merged_results",
    validation_inputs_dir: str = "validation_merged_results",
    num_cpus: int = 120,
):
    import classification

    classification.serialize_to_root(
        config_file, inputs_dir, validation_inputs_dir, num_cpus
    )


@classification_app.command()
def fold(
    inputs_dir: str = "classification_root_files",
    validation_inputs_dir: str = "validation_root_files",
    filters: list[str] = ["*"],
    num_cpus: int = 120,
):
    import classification

    classification.make_distributions(
        inputs_dir, validation_inputs_dir, filters, num_cpus
    )


@classification_app.command()
def unwrap_and_fold(
    config_file: str,
    unwrap_inputs_dir: str = "classification_merged_results",
    unwrap_validation_inputs_dir: str = "validation_merged_results",
    fold_inputs_dir: str = "classification_root_files",
    fold_validation_inputs_dir: str = "validation_root_files",
    filters: list[str] = ["*"],
    num_cpus: int = 120,
):
    unwrap(config_file, unwrap_inputs_dir, unwrap_validation_inputs_dir, num_cpus)
    fold(fold_inputs_dir, fold_validation_inputs_dir, filters, num_cpus)


############################################################################
############################################################################
# Plotter
############################################################################
############################################################################
plot_app = typer.Typer()


@plot_app.command()
def distribution(
    input_dir: str="classification_distribution_files",
    output_dir: str = "classification_plots",
    validation_input_dir: str="validation_distribution_files",
    validation_output_dir: str = "validation_plots",
    filters:list[str]=["*"],
    validation_filters:list[str]=["*"],
    num_cpus:int=120
):
    from plotter import plotter

    plotter(input_dir, filters, output_dir, num_cpus)
    plotter(validation_input_dir, validation_filters, validation_output_dir, num_cpus)


# @plot_app.command()
# def summary(config: str):
#     pass


############################################################################
############################################################################
# Scanner
############################################################################
############################################################################
scan_app = typer.Typer()


# @scan_app.command()
# def integral(config: str):
#     pass
#
#
# @scan_app.command()
# def scan(config: str):
#     pass


############################################################################
############################################################################
# Main
############################################################################
############################################################################
app = typer.Typer()
app.add_typer(classification_app, name="classification")
app.add_typer(scan_app, name="scan")
app.add_typer(plot_app, name="plot")

if __name__ == "__main__":
    app()
